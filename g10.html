<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aethelgard AI Adventures | Infinite Arcade</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Lora:ital,wght@0,400;0,600;1,400&display=swap"
        rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --bg: #0f0f11;
            --surface: rgba(20, 20, 25, .8);
            --border: rgba(212, 175, 55, .3);
            --accent: #d4af37
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        body {
            background: var(--bg);
            color: #e2e8f0;
            font-family: 'Lora', serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-image: linear-gradient(to bottom, #0f0f11, #1a1a24)
        }

        /* Dynamic background */
        .bg-image {
            position: fixed;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: -1;
            filter: blur(8px);
            background-image: url("file:///C:/Users/smahs/.gemini/antigravity/brain/08b2277f-edbb-4cd9-b27c-9042ffc4c8f5/g10_intro_1772268460097.png")
        }

        .bg-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, transparent 20%, #0f0f11 100%);
            z-index: -1;
            pointer-events: none
        }

        .back-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            color: var(--accent);
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: .9rem;
            z-index: 99;
            transition: .2s;
            font-family: 'Cinzel', serif;
            text-shadow: 0 0 10px rgba(0, 0, 0, .8)
        }

        .back-btn:hover {
            color: #fff;
            text-shadow: 0 0 10px var(--accent)
        }

        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
            z-index: 10;
            gap: 20px;
            padding-top: 40px;
            position: relative
        }

        /* Cards */
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, .8);
            width: 100%;
            position: relative;
            backdrop-filter: blur(10px);
            min-height: 400px;
            display: flex;
            flex-direction: column
        }

        /* Corner ornaments */
        .ornament {
            position: absolute;
            width: 40px;
            height: 40px;
            border: 2px solid var(--accent);
            opacity: 0.5;
            pointer-events: none
        }

        .ornament.tl {
            top: 10px;
            left: 10px;
            border-right: none;
            border-bottom: none
        }

        .ornament.tr {
            top: 10px;
            right: 10px;
            border-left: none;
            border-bottom: none
        }

        .ornament.bl {
            bottom: 10px;
            left: 10px;
            border-right: none;
            border-top: none
        }

        .ornament.br {
            bottom: 10px;
            right: 10px;
            border-left: none;
            border-top: none
        }

        h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            font-weight: 900;
            text-align: center;
            color: var(--accent);
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(212, 175, 55, .3)
        }

        .subtitle {
            text-align: center;
            color: #94a3b8;
            margin-bottom: 30px;
            font-style: italic
        }

        /* Home Screen Forms */
        .home-screen {
            display: flex;
            flex-direction: column;
            gap: 30px;
            width: 100%;
            animation: fadeIn .5s
        }

        .presets {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px
        }

        .preset-btn {
            padding: 15px;
            background: rgba(0, 0, 0, .4);
            border: 1px solid rgba(212, 175, 55, .2);
            border-radius: 8px;
            color: #cbd5e1;
            font-family: 'Cinzel', serif;
            cursor: pointer;
            transition: .2s;
            text-align: center
        }

        .preset-btn:hover {
            background: rgba(212, 175, 55, .1);
            border-color: var(--accent);
            color: var(--accent)
        }

        .preset-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
            color: var(--accent)
        }

        .preset-desc {
            font-family: 'Lora', serif;
            font-size: .85rem;
            opacity: 0.8
        }

        .custom-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
            background: rgba(0, 0, 0, .3);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .05)
        }

        .custom-form h3 {
            font-family: 'Cinzel', serif;
            color: var(--accent);
            margin-bottom: 10px
        }

        .input-grp {
            display: flex;
            flex-direction: column;
            gap: 5px
        }

        label {
            font-size: .9rem;
            color: #94a3b8;
            font-family: 'Cinzel', serif
        }

        input,
        textarea {
            padding: 12px 16px;
            background: rgba(0, 0, 0, .5);
            border: 1px solid rgba(255, 255, 255, .1);
            border-radius: 8px;
            color: #fff;
            font-family: 'Lora', serif;
            font-size: 1rem;
            outline: none;
            transition: .2s;
            resize: vertical
        }

        input:focus,
        textarea:focus {
            border-color: var(--accent);
            box-shadow: 0 0 10px rgba(212, 175, 55, .2)
        }

        .btn-start {
            padding: 16px 32px;
            background: linear-gradient(45deg, #785a00, #b8860b);
            border: none;
            border-radius: 8px;
            color: #fff;
            font-family: 'Cinzel', serif;
            font-weight: 900;
            font-size: 1.2rem;
            cursor: pointer;
            transition: .2s;
            box-shadow: 0 10px 20px rgba(0, 0, 0, .5);
            text-transform: uppercase;
            letter-spacing: 2px;
            align-self: center;
            margin-top: 10px
        }

        .btn-start:hover {
            background: linear-gradient(45deg, #b8860b, #daa520);
            transform: translateY(-2px);
            box-shadow: 0 15px 30px rgba(212, 175, 55, .3)
        }

        /* Game Screen */
        .game-screen {
            display: none;
            flex-direction: column;
            animation: fadeIn .5s;
            flex: 1
        }

        .story-meta {
            display: flex;
            justify-content: space-between;
            color: #94a3b8;
            font-size: .9rem;
            border-bottom: 1px solid rgba(255, 255, 255, .1);
            padding-bottom: 10px;
            margin-bottom: 20px
        }

        .story-text {
            font-size: 1.2rem;
            line-height: 1.8;
            color: #cbd5e1;
            margin-bottom: 40px;
            min-height: 150px;
            animation: fadeText 0.8s ease-out;
            white-space: pre-wrap
        }

        @keyframes fadeText {
            0% {
                opacity: 0;
                transform: translateY(10px)
            }

            100% {
                opacity: 1;
                transform: translateY(0)
            }
        }

        @keyframes fadeIn {
            0% {
                opacity: 0
            }

            100% {
                opacity: 1
            }
        }

        .choices {
            display: flex;
            flex-direction: column;
            gap: 12px;
            width: 100%;
            margin-top: auto
        }

        .btn-choice {
            padding: 16px 24px;
            border-radius: 8px;
            border: 1px solid rgba(212, 175, 55, .4);
            background: rgba(0, 0, 0, .4);
            color: var(--accent);
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: .3s;
            text-align: left;
            position: relative;
            overflow: hidden
        }

        .btn-choice:hover:not(:disabled) {
            background: rgba(212, 175, 55, .1);
            border-color: var(--accent);
            padding-left: 32px;
            box-shadow: 0 5px 15px rgba(212, 175, 55, .1)
        }

        .btn-choice::before {
            content: '►';
            position: absolute;
            left: 10px;
            opacity: 0;
            transition: .3s;
            color: #fff
        }

        .btn-choice:hover:not(:disabled)::before {
            opacity: 1
        }

        .btn-choice:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: rgba(255, 255, 255, .1);
            color: #94a3b8
        }

        .custom-action-box {
            display: none;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, .1);
        }

        .custom-action-box.show {
            display: flex;
        }

        .btn-custom {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            background: rgba(212, 175, 55, 0.2);
            color: var(--accent);
            font-family: 'Cinzel', serif;
            font-weight: 700;
            font-size: 1.1rem;
            cursor: pointer;
            transition: .3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-custom:hover {
            background: var(--accent);
            color: #000;
            box-shadow: 0 5px 15px rgba(212, 175, 55, .3);
        }

        /* Loader */
        .loader-wrap {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 20px;
            min-height: 300px
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(212, 175, 55, .2);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg)
            }
        }

        .loader-text {
            font-family: 'Cinzel', serif;
            color: var(--accent);
            animation: pulse 1.5s infinite
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1
            }

            50% {
                opacity: .5
            }
        }
    </style>
</head>

<body>
    <div class="bg-image"></div>
    <div class="bg-overlay"></div>
    <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Hub</a>

    <div class="container">
        <div class="card">
            <div class="ornament tl"></div>
            <div class="ornament tr"></div>
            <div class="ornament bl"></div>
            <div class="ornament br"></div>

            <!-- Home Screen -->
            <div class="home-screen" id="homeScreen">
                <h1>Echoes of the Infinite</h1>
                <div class="subtitle">An AI-Driven Interactive Fiction Engine</div>

                <h3 style="font-family:'Cinzel';color:var(--accent);text-align:center">Select a Tale</h3>
                <div class="presets">
                    <div class="preset-btn"
                        onclick="startPreset('The Lost City of Gold', 'Action Adventure', 'Indiana')">
                        <div class="preset-title">The Lost City</div>
                        <div class="preset-desc">Action Adventure • Indiana</div>
                    </div>
                    <div class="preset-btn"
                        onclick="startPreset('Echoes of the Void', 'Sci-Fi Horror', 'Commander Ripley')">
                        <div class="preset-title">Void Echoes</div>
                        <div class="preset-desc">Sci-Fi Horror • Ripley</div>
                    </div>
                    <div class="preset-btn"
                        onclick="startPreset('The Crimson Crown', 'High Fantasy Political', 'Lord Alaric')">
                        <div class="preset-title">Crimson Crown</div>
                        <div class="preset-desc">High Fantasy • Alaric</div>
                    </div>
                    <div class="preset-btn"
                        onclick="startPreset('Shadows of Neo-Tokyo', 'Cyberpunk Noir', 'Detective K')">
                        <div class="preset-title">Neo-Tokyo Shadows</div>
                        <div class="preset-desc">Cyberpunk Noir • Det. K</div>
                    </div>
                    <div class="preset-btn" onclick="startPreset('The Whispering Woods', 'Dark Fairy Tale', 'Elara')">
                        <div class="preset-title">Whispering Woods</div>
                        <div class="preset-desc">Dark Fairy Tale • Elara</div>
                    </div>
                </div>

                <div style="text-align:center;color:#94a3b8;margin:10px 0">— OR —</div>

                <div class="custom-form">
                    <h3>Forge Your Own Destiny</h3>
                    <div class="input-grp">
                        <label>Story Title</label>
                        <input type="text" id="cTitle" placeholder="e.g. Journey to the Center of the Earth">
                    </div>
                    <div class="input-grp">
                        <label>Genre / Mood</label>
                        <input type="text" id="cGenre" placeholder="e.g. Steampunk Mystery">
                    </div>
                    <div class="input-grp">
                        <label>Character Name</label>
                        <input type="text" id="cChar" placeholder="e.g. Professor Lidenbrock">
                    </div>
                    <div class="input-grp">
                        <label>Max Nodes (10-100)</label>
                        <input type="number" id="cNodes" min="10" max="100" value="20">
                    </div>
                    <div class="input-grp">
                        <label>Story Overview / Premise (Optional)</label>
                        <textarea id="cDesc" rows="3" placeholder="Describe the setting, goals, and tone..."></textarea>
                    </div>
                    <div class="input-grp"
                        style="flex-direction:row;align-items:center;gap:10px;margin-top:5px;cursor:pointer">
                        <input type="checkbox" id="cCustomOpt" style="width:20px;height:20px;cursor:pointer">
                        <label for="cCustomOpt"
                            style="cursor:pointer;color:var(--accent);margin:0;font-size:1rem;font-weight:bold;">Enable
                            Custom Action Input</label>
                    </div>
                    <button class="btn-start" onclick="startCustom()">Begin Journey</button>
                </div>
            </div>

            <!-- Game Screen -->
            <div class="game-screen" id="gameScreen">
                <h1 id="gameHeader">Title</h1>
                <div class="story-meta">
                    <span id="charTag">Character: Node</span>
                    <span id="depthTag">Node: 1/20</span>
                </div>

                <div id="storyContent">
                    <div class="story-text" id="storyText"></div>
                    <div class="choices" id="choicesBox"></div>
                    <div class="custom-action-box" id="customActionBox">
                        <input type="text" id="customInput" placeholder="Enter your own custom action..."
                            autocomplete="off">
                        <button class="btn-custom" onclick="submitCustomAction()">Commit Action</button>
                    </div>
                </div>

                <div class="loader-wrap" id="loader">
                    <div class="spinner"></div>
                    <div class="loader-text">The Weaver spins the thread...</div>
                </div>
            </div>

        </div>
    </div>

    <script>
        const GROQ_API_KEY = "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";

        // List of supported fallback models
        const MODELS = [
            "llama-3.3-70b-versatile",
            "llama-3.1-8b-instant",
            "meta-llama/llama-4-scout-17b-16e-instruct",
            "meta-llama/llama-4-maverick-17b-128e-instruct",
            "qwen/qwen3-32b",
            "moonshotai/kimi-k2-instruct",
            "groq/compound",
            "openai/gpt-oss-120b"
        ];

        let storyContext = [];
        let storyTitle = "";
        let storyGenre = "";
        let charName = "";
        let storyOverview = "";
        let depth = 0;
        let MAX_DEPTH = 20;
        let allowCustom = false;

        function startPreset(title, genre, char) {
            storyTitle = title; storyGenre = genre; charName = char;
            storyOverview = "";
            MAX_DEPTH = 20;
            allowCustom = false;
            launchGame();
        }

        function startCustom() {
            const t = document.getElementById('cTitle').value.trim();
            const g = document.getElementById('cGenre').value.trim();
            const c = document.getElementById('cChar').value.trim();
            const desc = document.getElementById('cDesc').value.trim();
            let n = parseInt(document.getElementById('cNodes').value);

            if (!t || !g || !c) return alert("Please fill Title, Genre, and Character Name.");
            if (isNaN(n) || n < 10) n = 10;
            if (n > 100) n = 100;

            storyTitle = t; storyGenre = g; charName = c;
            storyOverview = desc;
            MAX_DEPTH = n;
            allowCustom = document.getElementById('cCustomOpt').checked;
            launchGame();
        }

        function launchGame() {
            document.getElementById('homeScreen').style.display = 'none';
            document.getElementById('gameScreen').style.display = 'flex';
            document.getElementById('gameHeader').textContent = storyTitle;
            document.getElementById('charTag').textContent = `Character: ${charName}`;

            storyContext = [
                {
                    role: "system",
                    content: `You are an interactive fiction engine powering an RPG. 
Story Title: "${storyTitle}"
Genre: "${storyGenre}"
Protagonist: "${charName}"
${storyOverview ? `Story Overview/Premise: "${storyOverview}"` : ""}

CRITICAL RULES:
1. You MUST ALWAYS respond ONLY with a valid JSON object. No markdown formatting blocks around the JSON (e.g. do not use \`\`\`json). Just the raw JSON string.
2. Format:
{
  "text": "Narrative paragraph describing the current situation. Max 150 words.",
  "choices": [
    {"text": "Action choice 1"},
    {"text": "Action choice 2"}
  ],
  "outcome": "none" // Specify "win", "lose", or "none"
}
3. Keep the story engaging and reactive to the user's previous choice. If the player makes a fatally bad decision, you can end the story early by returning empty choices [] and "outcome": "lose".
4. Give 2 to 3 choices. If the story has reached a natural conclusion or the instructions say to end, provide an empty choices array: [].
Do NOT deviate from this JSON structure.`
                }
            ];

            depth = 0;
            fetchNextNode("Begin the story. Establish the setting and present the first predicament.");
        }

        async function fetchNextNode(userAction, modelIndex = 0) {
            if (modelIndex === 0) {
                depth++;
                document.getElementById('depthTag').textContent = `Node: ${depth}/${MAX_DEPTH}`;
                document.getElementById('storyContent').style.display = 'none';
                document.getElementById('loader').style.display = 'flex';
                // Only push user context once per user action, not on fallbacks.
                let promptAction = `User chose: ${userAction}`;
                if (depth >= MAX_DEPTH) {
                    promptAction += `. This is the final node. Conclude the story in a satisfying way and provide NO choices (empty array []). Based on the player's cumulative choices, evaluate whether they succeeded or failed. Set "outcome" to "win" or "lose".`;
                }
                storyContext.push({ role: "user", content: promptAction });
            }

            try {
                const response = await fetch("https://api.groq.com/openai/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${GROQ_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: MODELS[modelIndex],
                        messages: storyContext,
                        temperature: 0.7,
                        max_tokens: 500
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error?.message || "API Error");
                }

                let rawReply = data.choices[0].message.content.trim();

                // Assistant context saving
                storyContext.push({ role: "assistant", content: rawReply });

                // Clean potentially bad JSON formatting from LLM (removing ```json blocks if they exist despite instruction)
                if (rawReply.startsWith('```json')) rawReply = rawReply.substring(7);
                if (rawReply.startsWith('```')) rawReply = rawReply.substring(3);
                if (rawReply.endsWith('```')) rawReply = rawReply.substring(0, rawReply.length - 3);
                rawReply = rawReply.trim();

                const nodeData = JSON.parse(rawReply);
                renderNode(nodeData);

            } catch (e) {
                console.warn(`Model ${MODELS[modelIndex]} failed:`, e);

                // Try next model if we have fallbacks left
                if (modelIndex + 1 < MODELS.length) {
                    console.log(`Falling back to model ${MODELS[modelIndex + 1]}...`);
                    return fetchNextNode(userAction, modelIndex + 1);
                }

                // If all models failed
                console.error("All AI models failed.");
                document.getElementById('loader').style.display = 'none';
                document.getElementById('storyContent').style.display = 'block';
                document.getElementById('storyText').innerHTML = `<span style="color:#ef4444">The connection to the multiverse was lost. The magic has faded...<br><br>All AI Models Failed: ${e.message}</span>`;

                const choicesBox = document.getElementById('choicesBox');
                choicesBox.innerHTML = '';
                let b = document.createElement('button');
                b.className = 'btn-choice';
                b.textContent = "Retry Connection";
                b.onclick = () => {
                    storyContext.pop(); // remove the failed prompt attempt
                    depth--;
                    fetchNextNode(userAction);
                };
                choicesBox.appendChild(b);

                let br = document.createElement('button');
                br.className = 'btn-choice';
                br.textContent = "Return to Hub";
                br.onclick = () => location.reload();
                choicesBox.appendChild(br);
            }
        }

        function renderNode(data) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('storyContent').style.display = 'block';

            // Animate text reading
            const st = document.getElementById('storyText');
            st.style.animation = 'none';
            st.offsetHeight;
            st.style.animation = 'fadeText 0.8s ease-out';
            st.textContent = data.text;

            const choicesBox = document.getElementById('choicesBox');
            choicesBox.innerHTML = '';

            if (data.choices && data.choices.length > 0 && depth < MAX_DEPTH && (!data.outcome || data.outcome === "none")) {
                data.choices.forEach(ch => {
                    let b = document.createElement('button');
                    b.className = 'btn-choice';
                    b.textContent = ch.text;
                    b.onclick = () => fetchNextNode(ch.text);
                    choicesBox.appendChild(b);
                });

                if (allowCustom) {
                    document.getElementById('customActionBox').classList.add('show');
                    document.getElementById('customInput').value = '';
                } else {
                    document.getElementById('customActionBox').classList.remove('show');
                }
            } else {
                document.getElementById('customActionBox').classList.remove('show');

                let b = document.createElement('button');
                b.className = 'btn-choice';
                b.style.textAlign = "center";
                b.style.fontWeight = "bold";

                if (data.outcome === "win") {
                    b.innerHTML = "🏆 VICTORY! Return to Hub";
                    b.style.color = "#fbbf24";
                    b.style.borderColor = "#fbbf24";
                } else if (data.outcome === "lose") {
                    b.innerHTML = "💀 DEFEAT! Try Again";
                    b.style.color = "#ef4444";
                    b.style.borderColor = "#ef4444";
                } else {
                    b.innerHTML = "Your journey has ended. Return to Hub.";
                    b.style.color = "#10b981";
                }

                b.onclick = () => location.reload();
                choicesBox.appendChild(b);
            }
        }

        function submitCustomAction() {
            const val = document.getElementById('customInput').value.trim();
            if (!val) return;
            fetchNextNode(val);
        }

        document.getElementById('customInput').addEventListener('keydown', function (e) {
            if (e.key === 'Enter') submitCustomAction();
        });
    </script>
</body>

</html>